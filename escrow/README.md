# Signatures used for Authorization in Daemon

## High level flow

![Details](signature_diagram.png?raw=true "Title")


<BR>

## Details of Signature

<BR>
<BR>

| Type of Request | Check for State or Execute Service                                                               | Block chain Mode | allowed User Flag | Request                                                                                                                                                                                                                                                                                                                                                                      | Signature expected                                                                                                                                                                                                                                                                                                                                                                                                      | Method Called                                                                                                                                                          | Response sent                                                                                                      | Comments                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|-----------------|--------------------------------------------------------------------------------------------------|------------------|-------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Paid Call       | [Grpc State call](https://github.com/singnet/snet-daemon/blob/master/escrow/state_service.proto) | true             | NA                | [message ChannelStateRequest](https://github.com/singnet/snet-daemon/blob/master/escrow/state_service.proto#L20-L30)                                                                                                                                                                                                                                                         | "__get_channel_state"+MpeAddress+channelID+CurrentBlockNumber<BR> [Bytes Constructed](https://github.com/singnet/snet-daemon/blob/master/escrow/state_service.go#L79-L84)                                                                                                                                                                                                                                               | [rpc GetChannelState\(ChannelStateRequest\) returns \(ChannelStateReply\) \{\}](https://github.com/singnet/snet-daemon/blob/master/escrow/state_service.proto#L14-L17) | [message ChannelStateReply](https://github.com/singnet/snet-daemon/blob/master/escrow/state_service.proto#L36-L53) | Only channel signer/sender/receiver can get latest channel state . Current Block Number passed needs to be +-10 from the latest block number retrieved from the blockchain                                                                                                                                                                                                                                                                                                                                                              |
| Paid Call       | [Grpc State call](https://github.com/singnet/snet-daemon/blob/master/escrow/state_service.proto) | false            | NA                | [message ChannelStateRequest](https://github.com/singnet/snet-daemon/blob/master/escrow/state_service.proto#L20-L30)                                                                                                                                                                                                                                                         | NA                                                                                                                                                                                                                                                                                                                                                                                                                      | [rpc GetChannelState\(ChannelStateRequest\) returns \(ChannelStateReply\) \{\}](https://github.com/singnet/snet-daemon/blob/master/escrow/state_service.proto#L14-L17) | [message ChannelStateReply](https://github.com/singnet/snet-daemon/blob/master/escrow/state_service.proto#L36-L53) | Same response is sent every time,Caller would not know if the block chain mode is enabled or disabled.The Signature sent is ignored.                                                                                                                                                                                                                                                                                                                                                                                                    |
| Paid Call       | Execute Service                                                                                  | true             | true or false     | Metadata Passed to Daemon should consist of the below header<br> "snet-payment-type"="escrow" <br>"snet-payment-channel-id" = "Channeld"<br> "snet-payment-channel-nonce"="Nonce"<br> "snet-payment-channel-amount" ="TotalAmount"<br> "snet-payment-channel-signature-bin"="Signature"                                                                                      | "__MPE_claim_message"+MpeContractAddress+ChannelID+ChannelNonce+SignedAmount<br>[Bytes Constructed](https://github.com/singnet/snet-daemon/blob/3fb726ac903888efd03de4443f06a5cd294ae9f9/escrow/validation.go#L173-L179)                                                                                                                                                                                                | Call to the method in Service                                                                                                                                          | Response sent by Service                                                                                           | Only channel signer/sender can sign.<br>, Please note the Total Amount = Amount (retrieved from State call) + Price of the current call , latest nonce is also retrieved from the state call<br>if the allowed_user flag is true , then Make sure the Signer is also in the list of allowed users defined in the Daemon config.<br>Please note the [allowed user flag](https://github.com/singnet/snet-daemon/blob/master/README.md#allowed_users_flag) is applicable only in test networks like sepolia/goerli etc; but not in mainnet |
| Free Call       | Execute Service                                                                                  | true             | true or false     | Metadata Passed to Daemon should consist of the below header<br> "snet-payment-type"="free-call" <br>""snet-free-call-user-id" = "user-id"<br> "snet-free-call-auth-token-bin"="Auth Token downloaded"<br> "snet-free-call-token-expiry-block" ="Token Expiry date"<br> "snet-current-block-number"="CurrentBlockNumber" <br>"snet-payment-channel-signature-bin"="Signture" | Signature = "__prefix_free_trial"+"user-id"+"organization_id"+"service_id"+BlockNumber+"AuthToken", now check if Auth-token = "user@mail"+"user-public-key"+ "token_issue_date"<br>from the first signature get the user-public-key, and use this to validate the AuthToken<br>[Bytes Constructed](https://github.com/singnet/snet-daemon/blob/3fb726ac903888efd03de4443f06a5cd294ae9f9/escrow/validation.go#L173-L179) | Call to the method in Service                                                                                                                                          | Response sent by Service                                                                                           | Only channel signer/sender can sign.<br>, Please note the Total Amount = Amount (retrieved from State call) + Price of the current call , latest nonce is also retrieved from the state call<br>if the allowed_user flag is true , then Make sure the Signer is also in the list of allowed users defined in the Daemon config.<br>Please note the [allowed user flag](https://github.com/singnet/snet-daemon/blob/master/README.md#allowed_users_flag) is applicable only in test networks like sepolia/goerli etc; but not in mainnet |

<br>[Details on headers](https://github.com/singnet/snet-daemon/blob/master/handler/interceptors.go#L24-L43)

